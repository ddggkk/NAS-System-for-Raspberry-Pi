'use strict';var _Mathmin=Math.min,_Mathceil=Math.ceil,_Mathfloor=Math.floor,_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(g){return typeof g}:function(g){return g&&'function'==typeof Symbol&&g.constructor===Symbol&&g!==Symbol.prototype?'symbol':typeof g},_createClass=function(){function g(_,C){for(var E,z=0;z<C.length;z++)E=C[z],E.enumerable=E.enumerable||!1,E.configurable=!0,'value'in E&&(E.writable=!0),Object.defineProperty(_,E.key,E)}return function(_,C,z){return C&&g(_.prototype,C),z&&g(_,z),_}}();function _possibleConstructorReturn(g,_){if(!g)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return _&&('object'==typeof _||'function'==typeof _)?_:g}function _inherits(g,_){if('function'!=typeof _&&null!==_)throw new TypeError('Super expression must either be null or a function, not '+typeof _);g.prototype=Object.create(_&&_.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}),_&&(Object.setPrototypeOf?Object.setPrototypeOf(g,_):g.__proto__=_)}function _classCallCheck(g,_){if(!(g instanceof _))throw new TypeError('Cannot call a class as a function')}$(function(){window.OS=new os});var os=function(){function g(){var _=this;return _classCallCheck(this,g),isMobile&&$('body').on('touchstart',function(){if(!(document.fullscreen||document.webkitIsFullScreen||document.mozIsFullScreen||document.msIsFullScreen)){try{document.documentElement.requestFullScreen()}catch(C){}try{document.documentElement.mozRequestFullScreen()}catch(C){}try{document.documentElement.webkitRequestFullScreen()}catch(C){}try{document.documentElement.msRequestFullScreen()}catch(C){}}}),localStorage.power?void this.reload():void(this.name='box',this.storage='file:///'+DEVINFO.storage+'/storage/',this.$win=$('body'),this.desktop=new desktop,this.alert=function(C){return _.desktop.win.alert(C)},this.confirm=function(C,z,E){return _.desktop.win.confirm(C,z,E)},this.prompt=function(C,z,E,P){return _.desktop.win.prompt(C,z,E,P)},this.progress=function(C,z){return _.desktop.win.progress(C,z)},this.print=function(C){if(!_.printFrame){var z=document.createElement('iframe');$(z).appendTo('body').hide(),_.printFrame=z.contentWindow}_.printFrame.document.body.innerHTML='',_.printFrame.document.write('<pre>'+C+'</pre>'),_.printFrame.print()},this.logout=function(){OS.confirm($.l10n.__('logouttext'),function(C){C&&API.logout()})},this.reboot=function(){OS.confirm($.l10n.__('reboottext'),function(C){C&&(API.auth.reboot({nowaiting:!0}),localStorage.power='loading',_.reload())})},this.poweroff=function(){OS.confirm($.l10n.__('powerofftext'),function(C){C&&(API.auth.poweroff(),localStorage.power='off',_.reload())})},this.passwd=function(){OS.confirm('<table class="table changepass"><tr><td>'+$.l10n.__('newpass')+'</td><td><input type="password"/></td></tr><tr><td>'+$.l10n.__('confirmpass')+'</td><td><input type="password"/></td></tr><tr><td></td><td></td></tr></table>',function(C){if(C){var z=$('table.table.changepass'),E=$.trim($('input:first',z).val()),P=$.trim($('input:last',z).val());E===P&&''!==E?API.auth.passwd({data:{pass:E},success:function success(){return C.close()}}):$('td:last',z).html($.l10n.__('checkinput'))}},!0)},this.path=new path,this.apps=[],this.loadApps(),this.clipboard={},this.loaddevinfo())}return _createClass(g,[{key:'loaddevinfo',value:function loaddevinfo(){var _=this;API.info.base({data:{_:new Date().getTime()},success:function success(C){DEVINFO=C,sessionStorage.devinfo=JSON.stringify(C),document.title=C.hostname,_.storage='file:///'+C.storage+'/storage/'}})}},{key:'reload',value:function reload(){if($('html').css({background:'#000'}),'loading'===localStorage.power){$('body').empty().css({background:'#000'}),$('body').html('<progress style="width:100%;height:5px;position:fixed;border:none;"></progress>');var _=0;setInterval(function(){_+=1e-3,1<=_&&(_=0),$('progress').val(_)},10),setInterval(function(){return API.info.status({nowaiting:!0,success:function success(){return location='../index.html'}})},3e3)}'off'===localStorage.power&&$('body').css({overflow:'hidden'}).animate({opacity:0},3e3,function(){return $('body').html('$').css({opacity:1,background:'none',fontFamily:'box',fontSize:'22px',color:'#fff',display:'flex',alignItems:'center',justifyContent:'center'})})}},{key:'loadApps',value:function loadApps(){var _=this;API.info.getapps({success:function success(C){for(i in C){var z=C[i],E=!0,P=!1,T=void 0;try{for(var S,O,M=z[Symbol.iterator]();!(E=(S=M.next()).done);E=!0)(O=S.value,!O.options.admin||USERINFO.admin)&&(_[O.name]=new app(O,i),!1!==O.options.startmenu&&_.apps.push(_[O.name]))}catch(O){P=!0,T=O}finally{try{!E&&M.return&&M.return()}finally{if(P)throw T}}}},error:function error(){}})}}]),g}(),app=function(){function app(g,_){_classCallCheck(this,app),'string'==typeof g&&(g={name:g}),this.name=g.name,this.path=_+'/'+this.name+'/',this.icon=_+'/'+this.name+'/icon.svg',this.conf=_+'/'+this.name+'/conf.json',this.url=_+'/'+this.name+'/index.html',this.caption=this.caption?'string'==typeof this.caption?this.caption:this.caption[LANGUAGE]?this.caption[LANGUAGE]:this.caption.en:this.name,g.options&&this.set(g.options)}return _createClass(app,[{key:'load',value:function load(fo,wo){var _this4=this;if(this.win){this.win.active();var o=fo,w=this.win;return void(this.options.init&&eval(this.options.init))}if(this.options)return void this.init(fo,wo);if(this.state&&'loading'===this.state){var i=setInterval(function(){'loaded'===_this4.state&&(_this4.load(fo,wo),clearInterval(i))},100);return}this.state='loading',$.getJSON(this.conf,function(g){_this4.state='loaded',_this4.set(g),_this4.init(fo,wo)})}},{key:'set',value:function set(g){var _=this,g=$.extend({app:this,caption:this.name,url:g.content||''===g.content?'':this.url,width:800,height:600,onclose:function onclose(){_.win&&delete _.win}},g);'object'===_typeof(g.caption)&&(g.caption=g.caption[LANGUAGE]||g.caption.en),this.caption=g.caption,this.options=g}},{key:'init',value:function init(o,wo){if(this.options.admin&&!USERINFO.admin)return void OS.alert($.l10n.__('needadmin'));this.options.css&&loadCSS(this.path+this.options.css);var w=new win(o,$.extend(wo,this.options));return(this.options.unique||!this.options.multiwin)&&(this.win=w),this.options.init&&eval(this.options.init),w}}]),app}(),desktop=function(){function g(){_classCallCheck(this,g),this.draw()}return _createClass(g,[{key:'draw',value:function draw(){var _=this;$('html,body').css({width:'100%',height:'100%',margin:0,padding:0,overflow:'hidden',"-moz-user-select":'none',"-webkit-user-select":'none'}),this.draghelper=document.createElement('div'),this.draghelper.style.cssText='position:absolute;left:-1000px;top:-1000px;width:84px;height:84px;background-repeat:no-repeat;background-position:center center;background-size:contain;',this.$children=$(document.createElement('div')),this.$panel=$(document.createElement('div')),this.panel=new panel({container:this.$panel}),this.$panel.append(this.panel.$dom);var C=function _e(z){z.stopPropagation(),z.preventDefault()};$('body').css({background:'url("'+DOMAIN+'desktop:///.background") no-repeat center center/cover'}).append([this.$children,this.$panel,this.draghelper]).on('contextmenu',function(){return!1}),$('body > *').css({position:'fixed'}).on('dragover',function(z){return C(z)}).on('dragenter',function(z){return C(z)}).on('dragleave',function(z){return C(z)}).on('drop',function(z){return C(z)}),setTimeout(function(){_.win=new win({},{desktop:!0,app:OS}),$('body').append([_.win.$topwin,_.win.$modal]),_.load()},50),$(window).resize(function(){return _.panel.set()}),$('body').mousedown(function(z){var E=$(z.target).parentsUntil('.win.app.active');E[E.length-1]==document.documentElement&&$('.win.app.active').removeClass('active')})}},{key:'load',value:function load(){isMobile||new fileManager({isdesktop:!0},this.win)}},{key:'show',value:function show(){this.$children.show()}},{key:'hide',value:function hide(){this.$children.hide()}},{key:'background',value:function background(_){$('body').css({backgroundImage:'url("'+DOMAIN+_+'")'}),API.files.setbackground({data:{path:_}})}}]),g}(),panel=function(){function g(_){_classCallCheck(this,g),_=$.extend({size:40,position:'bottom',autohide:!1,lock:!1,container:''},_),this.options=_,this.size=_.size,this.draw(),this.set()}return _createClass(g,[{key:'draw',value:function draw(){var _=this,C=$('body'),z=C.width(),E=C.height(),P=this.options.size,T=2*this.options.size;this.$dom=$(document.createElement('div')),this.$taskbar=$(document.createElement('div')),this.$taskbar.css({flexGrow:99,overflow:'hidden'}).addClass('taskbar'),isMobile&&this.$taskbar.hide(),this.$mainmenu=$(document.createElement('div')),this.$mainmenu.addClass('mainmenu icon'),this.$taskview=$(document.createElement('div')),this.$taskview.addClass('taskview icon'),this.$mount=$(document.createElement('div')),this.$mount.addClass('mount icon'),this.$time=$(document.createElement('div')),this.$time.addClass('time icon'),this.$temp=$(document.createElement('div')),this.$temp.addClass('temp icon'),this.$bluetooth=$(document.createElement('div')),this.$bluetooth.addClass('bluetooth icon'),this.$wifi=$(document.createElement('div')),this.$wifi.addClass('wifi icon'),this.$notification=$(document.createElement('div')),this.$notification.addClass('notification icon'),this.$preferences=$(document.createElement('div')),this.$preferences.addClass('preferences icon'),this.$showdesktop=$(document.createElement('div')),this.$showdesktop.addClass('showdesktop icon'),this.$quit=$(document.createElement('div')),this.$quit.addClass('quit icon'),this.$power=$(document.createElement('div')),this.$power.addClass('power icon'),this.$menu=$(document.createElement('div')),this.$menu.css({position:'fixed',width:'auto',height:'auto'}).addClass('menu').hide(),this.$mainmenu_menu=$(document.createElement('div')),this.$mainmenu_menu.css({position:'fixed'}).addClass('mainmenu menu').hide(),isMobile&&this.$mainmenu_menu.css({width:'100%',height:'calc(100% - '+this.options.size+'px)'}),this.$notification_menu=$(document.createElement('div')),this.$notification_menu.css({position:'fixed'}).addClass('notification menu').hide(),this.$dom.addClass('panel').css({position:'fixed',display:'flex',fontSize:0}).append([this.$mainmenu,this.$taskview,isMobile?'':this.$showdesktop,this.$taskbar,USERINFO.admin?this.$preferences:'',this.$quit,USERINFO.admin?this.$bluetooth:'',USERINFO.admin?this.$wifi:'',this.$quit,this.$time,USERINFO.admin?this.$power:'',this.$menu,this.$mainmenu_menu,this.$notification_menu]).appendTo(this.options.container).draggable({helper:'clone',opacity:1e-3,start:function start(){addMask()},stop:function stop(M){clearMask(),_.set(M.pageX<T&&M.pageY>T&&M.pageY<E-T?'left':M.pageX>z-T&&M.pageY>T&&M.pageY<E-T?'right':M.pageX>T&&M.pageX<z-T&&M.pageY<T?'top':M.pageX>T&&M.pageX<z-T&&M.pageY>E-T?'bottom':_.options.position)}}),$('>.icon',this.$dom).css({width:P,height:P}),$('>.menu',this.$dom).css({whiteSpace:'nowrap'}),this.$menus=$('>.menu',this.$dom),C.mousedown(function(){setTimeout(function(){_.$menus.hide()},100)}),this.$mainmenu.mousedown(function(){setTimeout(function(){return _.showMainMenu()},300)}),this.$bluetooth.mousedown(function(){setTimeout(function(){return _.showBluetoothMenu()},300)}),this.$wifi.mousedown(function(){setTimeout(function(){return _.showWifiMenu()},300)}),this.$time.html(dateTimeToString(new Date(DEVINFO.time),'hh:mm')).mousedown(function(){setTimeout(function(){return _.showTime()},300)}),setInterval(function(){DEVINFO.time+=1e3,_.$time.html(dateTimeToString(new Date(DEVINFO.time),'hh:mm'))},1e3),this.$notification.mousedown(function(){setTimeout(function(){return _.showNotificationMenu()},300)}),this.$temp.mousedown(function(){return OS.Temperature.load()}),this.$preferences.mousedown(function(){return OS.Preferences.load()}),this.$quit.mousedown(function(){setTimeout(function(){return _.showQuitMenu()},300)}),this.$power.mousedown(function(){setTimeout(function(){return _.showPowerMenu()},300)}),this.$taskview.mousedown(function(){setTimeout(function(){return _.showTaskview()},300)}),this.$showdesktop.mousedown(function(){setTimeout(function(){return OS.desktop.win.$children.toggle()},100)}),$(window).resize(function(){_.set()})}},{key:'set',value:function set(_){_||(_=this.options.position),isMobile&&(_='bottom'),this.options.position=_;var C=$('body'),z=this.size,E=C.width(),P=C.height(),T=$('.win.maxed');switch(_){case'top':this.$dom.css({flexDirection:'row',width:E,height:z,left:0,top:0}),this.$menu.css({top:z,right:'auto',bottom:'auto'}),this.$mainmenu_menu.css({left:0,top:z,bottom:'auto'}),this.$notification_menu.css({right:0,top:z,height:'calc(100% - '+z+'px)'}),T.css({left:0,top:z,width:E,height:P-z});break;case'bottom':if(this.$dom.css({display:'flex',flexDirection:'row',width:E,height:z,left:0,top:'auto',bottom:0}),this.$menu.css({bottom:z,top:'auto',right:'auto'}),this.$mainmenu_menu.css({left:0,bottom:z,right:'auto',top:'auto'}),this.$notification_menu.css({right:0,top:0,height:'calc(100% - '+z+'px)'}),T.css({left:0,top:0,width:E,height:P-z}),isMobile){var M=$('>.icon',this.$dom),S=M.length;M.css({width:E/S})}break;case'left':this.$dom.css({display:'flex',flexDirection:'column',width:z,height:P,left:0,top:0}),this.$menu.css({left:z,right:'auto',bottom:'auto'}),this.$mainmenu_menu.css({left:z,top:0,right:'auto',bottom:'auto'}),this.$notification_menu.css({right:0,top:0,height:'100%'}),T.css({left:z,top:0,width:E-z,height:P});break;case'right':this.$dom.css({display:'flex',flexDirection:'column',width:z,height:P,left:'auto',right:0,top:0}),this.$menu.css({left:'auto',right:z,bottom:'auto'}),this.$mainmenu_menu.css({top:0,right:z,left:'auto',bottom:'auto'}),this.$notification_menu.css({right:z,top:0,height:'100%'}),T.css({left:0,top:0,width:E-z,height:P});}}},{key:'showMainMenu',value:function showMainMenu(){var _=this;this.$mainmenu_menu.toggle(),this.$mainmenu_menu.empty();var C=!0,z=!1,E=void 0;try{for(var M,P=function _loop(){var S=M.value,O=$(document.createElement('div'));O.html(S.caption).css({backgroundImage:'url('+S.icon+')'}),_.$mainmenu_menu.append(O),O.mousedown(function(){S.load()})},T=OS.apps[Symbol.iterator]();!(C=(M=T.next()).done);C=!0)P()}catch(S){z=!0,E=S}finally{try{!C&&T.return&&T.return()}finally{if(z)throw E}}}},{key:'showTime',value:function showTime(){var _=this;this.$menu.html(''),API.info.gettime({success:function success(C){DEVINFO.time=new Date(C.time);var z=dateTimeToString(DEVINFO.time,'YYYY/M/D hh:mm:ss').split(' ');_.$menu.html('<div style="text-align:center;"><div style="font-size:48px;">'+z[1]+'</div><div style="font-size:14px;">'+z[0]+'</div></div>').show(),_.setMenu(_.$time)}})}},{key:'showWifiMenu',value:function showWifiMenu(){var _=this;this.$menu.html(''),API.info.getnetwork({success:function success(C){var z=!0,E=!1,P=void 0;try{for(var M,S,T=C.adapter[Symbol.iterator]();!(z=(M=T.next()).done);z=!0)if(S=M.value,S.list){var O=[],I=!0,D=!1,N=void 0;try{for(var L,U,Y=S.list[Symbol.iterator]();!(I=(L=Y.next()).done);I=!0)U=L.value,O.push('<div class="'+(S.essid===U.essid?'selected':'')+'" name="'+S.name+'" essid="'+U.essid+'" encryption="'+U.encryption+'" key="'+U.key+'"><label style="display:block;width:100%">'+U.essid+(S.essid===U.essid&&''!==S.ipaddr?' ['+S.ipaddr+']':'')+'</label><span style="display:none">'+('off'==U.key?'':'<input placeholder="'+$.l10n.__('password')+'" style="width:100%"><br>')+'<button>'+$.l10n.__('connect')+'</button></span></div>')}catch(X){D=!0,N=X}finally{try{!I&&Y.return&&Y.return()}finally{if(D)throw N}}_.$menu.html(O.join(''))}}catch(X){E=!0,P=X}finally{try{!z&&T.return&&T.return()}finally{if(E)throw P}}$('*',_.$menu).mousedown(function(X){X.stopPropagation()}),$('label',_.$menu).mousedown(function(X){$('span',_.$menu).hide(),$(X.target.parentNode).hasClass('disabled')||$('span',X.target.parentNode).show()}),$('button',_.$menu).mousedown(function(X){_.$menu.hide();var G=$(X.target.parentNode.parentNode),R=G.attr('key'),V=$.trim($('input',G).val());'off'==R&&(V='none'),''==V||API.info.setnetwork({data:{name:G.attr('name'),dhcp:!0,essid:G.attr('essid'),psk:V}})}),_.$menu.show(),_.setMenu(_.$wifi)}})}},{key:'showBluetoothMenu',value:function showBluetoothMenu(){var _=this;this.$menu.html(''),API.info.getbluetooth({data:{pid:this.bluetooth_pid||''},success:function success(C){_.bluetooth_pid=C.pid;var z=!0,E=!1,P=void 0;try{for(var M,T=C.dev[Symbol.iterator]();!(z=(M=T.next()).done);z=!0){var S=M.value,O=document.createElement('div');O.data=S,O.className='0'===S.Paired?'':'selected',O.innerHTML='<label style="display:block;width:100%">'+S.Name+'</label><span style="display:none">'+('0'==S.Paired?'':'<button dev="'+S.Address+'" name="'+('0'==S.Connected?'connect':'disconnect')+'">'+$.l10n.__('0'==S.Connected?'connect':'disconnect')+'</button>')+'<button dev="'+S.Address+'" name="'+('0'==S.Paired?'pair':'unpair')+'">'+$.l10n.__('0'==S.Paired?'pair':'unpair')+'</button></span></div>',_.$menu.append(O)}}catch(I){E=!0,P=I}finally{try{!z&&T.return&&T.return()}finally{if(E)throw P}}$('*',_.$menu).mousedown(function(I){I.stopPropagation()}),$('label',_.$menu).mousedown(function(I){$('span',_.$menu).hide(),$(I.target.parentNode).hasClass('disabled')||$('span',I.target.parentNode).show()}),$('button',_.$menu).mousedown(function(I){_.$menu.hide();var D=$(I.target).attr('name'),N=$(I.target).attr('dev');API.info[D+'bluetooth']({data:{dev:N}})}),_.$menu.show(),_.setMenu(_.$wifi)}})}},{key:'showNotificationMenu',value:function showNotificationMenu(){this.$notification_menu.toggle(),this.$notification_menu.empty()}},{key:'showQuitMenu',value:function showQuitMenu(){var _=this;this.$menu.html('<div class="passwd">'+$.l10n.__('changepass')+'</div><div class="logout">'+$.l10n.__('logout')+'</div>'),$('span',this.$menu).mousedown(function(C){C.stopPropagation(),_.$menu.hide()}),$('.passwd',this.$menu).mousedown(function(){return OS.passwd()}),$('.logout',this.$menu).mousedown(function(){return OS.logout()}),this.$menu.show(),this.setMenu(this.$quit)}},{key:'showPowerMenu',value:function showPowerMenu(){var _=this;this.$menu.html('<div class="reboot">'+$.l10n.__('reboot')+'</div><div class="poweroff">'+$.l10n.__('poweroff')+'</div>'),$('span',this.$menu).mousedown(function(C){C.stopPropagation(),_.$menu.hide()}),$('.reboot',this.$menu).mousedown(function(){return OS.reboot()}),$('.poweroff',this.$menu).mousedown(function(){return OS.poweroff()}),this.$menu.show(),this.setMenu(this.$power)}},{key:'showTaskview',value:function showTaskview(){if($('body').hasClass('taskview')&&OS.desktop.curwin)return void OS.desktop.curwin.active();$('body').addClass('taskview');var _=$('body').width(),C=$('body').height(),z=$('.win.app'),E=1,T=z.length,M=10,S=0,O=M,I=0,D=0,N=0,Y=isMobile?.8*_:400,L=isMobile?Y*C/_:300,U=Y/L,X=_Mathfloor((_-M)/(Y+M)),G=_Mathceil(T/X),R=function m(){Y-=1,L=Y/U,X=_Mathfloor((_-M)/(Y+M)),G=_Mathceil(T/X),G*(L+M)>C-M&&R()};G*L>C&&R(),S=(_+M-(Y+M)*_Mathmin(T,X))/2,I=Math.max((C+M-G*(L+M))/2,M),O=S,z.each(function(){var V=$(this),K=$(this).is(':visible');$(this).css({overflow:'hidden'}).show(),this.originalPosition=V.position(),this.originalPosition.visible=K,D=V.width(),N=V.height();var Q=0,J=0,Z=D/N>=U?Y/D:L/N;D/N<U?Q=(Y-D*Z)/2:J=(L-N*Z)/2,V.removeClass('active').css({transform:'scale('+Z+')',left:S-D*(1-Z)/2+Q,top:I-N*(1-Z)/2+J}),S=S+Y+M,0==E%X&&(S=O,I=I+L+M),E++})}},{key:'addTask',value:function addTask(_){var C=this;if(_.app!==OS){var z=$('.'+_.appname,this.$taskbar);if(!z[0]){var z=$(document.createElement('div'));z.addClass(_.appname+' icon').css({display:'inline-block',width:this.size,height:this.size,backgroundRepeat:'no-repeat',backgroundPosition:'center center',"background-size":'$(this.size)px '+this.size+'px',backgroundImage:'url('+_.icon+')'}),this.$taskbar.append(z),z.click(function(E){return C.showTask(E,z)})}z.data().tasks||(z.data().tasks=[]),z.data().tasks.push(_),_.$taskbar=z}}},{key:'showTask',value:function showTask(_,C){var z=this;if(_.stopPropagation(),this.$menus.hide(),this.$menu.empty(),1===C.data().tasks.length){var I=C.data().tasks[0];I.$win.hasClass('active')?I.min():I.active()}else{var E=!0,P=!1,T=void 0;try{for(var O,M=function _loop2(){var I=O.value,D=$(document.createElement('div')),N=$(document.createElement('span'));N.addClass('close'),N.click(function(Y){Y.stopPropagation(),I.close(),D.remove()}),D.html([N,I.caption]).mousedown(function(Y){Y.stopPropagation(),z.$menu.hide(),I.active()}),z.$menu.append(D)},S=C.data().tasks[Symbol.iterator]();!(E=(O=S.next()).done);E=!0)M()}catch(I){P=!0,T=I}finally{try{!E&&S.return&&S.return()}finally{if(P)throw T}}this.$menu.show(),this.setMenu(C)}}},{key:'setMenu',value:function setMenu(_){switch(this.options.position){case'top':case'bottom':var C=$('body').width(),z=this.$menu.width(),E=_.position().left;E+z>=C?this.$menu.css({left:'auto',right:0}):this.$menu.css({left:E,right:'auto'});break;case'left':case'right':var P=$('body').height(),T=this.$menu.height(),M=_.position().top;M+T>=P&&(M=P-T),this.$menu.css({top:M});}}},{key:'removeTask',value:function removeTask(_){if(_.$taskbar){var C=_.$taskbar.data().tasks,z=[],E=!0,P=!1,T=void 0;try{for(var S,O,M=C[Symbol.iterator]();!(E=(S=M.next()).done);E=!0)O=S.value,O.closed||z.push(O)}catch(I){P=!0,T=I}finally{try{!E&&M.return&&M.return()}finally{if(P)throw T}}0===z.length&&_.$taskbar.remove()}}},{key:'activeTask',value:function activeTask(_){_.$taskbar&&($('.selected',this.$taskbar).removeClass('selected'),_.$taskbar.addClass('selected'))}},{key:'deactiveTask',value:function deactiveTask(_){_.$taskbar&&_.$taskbar.removeClass('selected')}}]),g}(),win=function(){function win(fo,wo){var _this16=this;if(_classCallCheck(this,win),fo||(fo={}),wo||(wo={}),wo&&wo.id){var _id=$('#'+wo.id)[0];if(_id&&_id.win)return void _id.win.active()}wo.parent||(wo.parent=OS.desktop.win||OS.desktop);var $p=wo.parent.$win||$('body');$p.show();var w=$p.width(),h=$p.height();this.param=fo,isMobile&&wo.popup&&(wo.center=!0,wo.width=_Mathmin(wo.width,w-40),wo.height=_Mathmin(wo.height,h-40)),this.options=$.extend({id:new Date().getTime(),caption:'',content:'',url:'',left:wo.left||wo.center?(w-(wo.width||600))/2:rand(0,w-(wo.width||600)),top:wo.top||wo.center?(h-(wo.height||400))/2:rand(0,h-(wo.height||400)),width:600,height:400,min_width:300,min_height:200,center:!1,resizable:!0,draggable:!0,min_button:!0,max_button:!0,close_button:!0,ontop:!1,type:'normal',maxed:!1,mined:!1,onload:null,onclose:null,onactive:null,ondeactive:null,onresize:null,ondrag:null},wo),this.caption=this.options.caption,this.app=wo.app,this.appname=wo.app?wo.app.name:'',this.icon=wo.app?wo.app.icon:'',this.parent=this.options.parent,this.state=this.options.state,this.$win=$(document.createElement('div')),this.$win.attr('id',this.options.id).addClass('win '+(wo.app?wo.app.desktop?'desktop ':'app ':'')+this.appname+(this.options.classname||'')).css({position:'absolute',width:this.options.width,height:this.options.height,top:0>this.options.top?0:this.options.top,left:0>this.options.left?0:this.options.left,overflow:'visible'}),this.$win[0].win=this,this.$caption=$(document.createElement('div')),this.$caption.addClass('caption'),this.$top=$(document.createElement('div')),this.$top.addClass('n border'),this.$bottom=$(document.createElement('div')),this.$bottom.addClass('s border'),this.$left=$(document.createElement('div')),this.$left.addClass('w border'),this.$right=$(document.createElement('div')),this.$right.addClass('e border'),this.$top_left=$(document.createElement('div')),this.$top_left.addClass('nw border'),this.$top_right=$(document.createElement('div')),this.$top_right.addClass('ne border'),this.$bottom_left=$(document.createElement('div')),this.$bottom_left.addClass('sw border'),this.$bottom_right=$(document.createElement('div')),this.$bottom_right.addClass('se border'),this.$control=$(document.createElement('div')),this.$control.addClass('control'),this.$control.css({zIndex:1}),this.options.close_button&&(this.$close=this.options.close_button?$(document.createElement('div')):null,this.$close&&this.$close.addClass('close')),this.options.max_button&&(this.$max=this.options.max_button?$(document.createElement('div')):null,this.$max&&this.$max.addClass('max'),isMobile&&this.$max.hide()),this.options.min_button&&(this.$min=this.options.min_button?$(document.createElement('div')):null,this.$min&&this.$min.addClass('min')),this.$content=$(document.createElement('div')),this.$content.addClass('content'),this.$content.css({zIndex:2}),this.$frame=$(document.createElement('iframe')),this.$frame.addClass('content'),this.$frame.css({zIndex:2}),this.$mask=$(document.createElement('div')),this.$mask.addClass('mask').css({zIndex:3,background:'rgba(0,0,0,0)'}),this.$waiting=$(document.createElement('div')),this.$waiting.addClass('waiting').css({zIndex:3,display:'none'}),this.$children=$(document.createElement('div')),this.$children.addClass('children').css({zIndex:4}),this.$topwin=$(document.createElement('div')),this.$topwin.addClass('topwin').css({zIndex:5}),this.options.desktop&&this.$topwin.css({position:'fixed',left:0,top:0}),this.$modal=$(document.createElement('div')),this.$modal.addClass('modal').css({zIndex:6}),'string'==typeof this.options.onload&&eval('this.options.onload='+this.options.onload),this.child=function(g){return new win($.extend({parent:_this16},g))},this.modal=function(g){return new win($.extend({parent:_this16},g))},this.alert=function(g){return new alert_win({content:g,parent:_this16})},this.confirm=function(g,_,C){return new confirm_win({content:g,callback:_,parent:_this16,keep:C})},this.prompt=function(g,_,C,z){return new prompt_win({caption:g,pre:_,content:C,callback:z,parent:_this16})},this.progress=function(g,_){return new progress_win({caption:g,callback:_,parent:_this16})},this.dialog=function(g){return new dialog_win($.extend({parent:_this16},g))},this.open=function(g){return _this16.dialog({left:10,top:30,caption:$.l10n.__('open'),classname:'files',onload:function onload(_){var C=$.extend({button:'open'},g);new fileManager(C,_)}})},this.opendir=function(g){return _this16.dialog({left:10,top:30,width:400,caption:$.l10n.__('open'),classname:'files',onload:function onload(_){var C=$.extend({filter:'folder'},g);new fileManager(C,_)}})},this.save=function(g){return _this16.dialog({left:10,top:30,caption:$.l10n.__('save'),classname:'files',onload:function onload(_){var C=$.extend({button:'save',single:!0},g);new fileManager(C,_)}})},this.draw(),this.load(),this.active()}return _createClass(win,[{key:'draw',value:function draw(){var g=this,_=$('body');switch(this.options.type){case'modal':this.$container=this.parent.$modal;break;case'top':this.$container=this.parent.$topwin;break;default:this.$container=this.parent.$children;}this.options.desktop?(this.$win.append([this.$content,this.$frame,this.$children,this.$modal,this.$topwin]).addClass('maxed').css({left:0,top:0,width:_.width(),height:_.height(),background:'none',border:'none',opacity:1}).show().appendTo(this.$container),this.$content.css({top:0,width:'100%',height:'100%'})):(this.$win.append([this.$top,this.$bottom,this.$left,this.$top_right,this.$top_left,this.$top_right,this.$bottom_left,this.$top_right,this.$caption,this.$control,this.$content,this.$frame,this.$mask,this.$waiting,this.$children,this.$modal,this.$topwin]).appendTo(this.$container),this.$control.append([this.$min||'',this.$max||'',this.$close||'']).appendTo(this.$win),this.$caption.html(this.options.caption)),$('>*',this.$win).css({position:'absolute'}),(isMobile&&!this.options.popup||this.options.maxed&&this.$max&&!this.options.desktop)&&this.max(),this.options.mined&&this.$min&&!this.options.desktop&&this.min(),this.options.draggable&&!this.options.desktop&&this.$win.draggable({start:function start(){return 2!==g.state&&void addMask()},stop:function stop(){g.store(),clearMask()},drag:function drag(z,E){var P=_.width(),T=_.height();(0===z.pageX||z.pageX===P)&&(E.position.left0=E.position.left),(0===z.pageY||z.pageY===T)&&(E.position.top0=E.position.top),(0>z.pageX||z.pageX>P)&&(E.position.left=E.position.left0),(0>z.pageY||z.pageY>T)&&(E.position.top=E.position.top0)},handle:'.n,.caption',scroll:!1}),this.options.resizable&&!this.options.desktop&&(this.$win.resizable({handles:'n,s,e,w,ne,nw,se,sw',start:addMask,stop:function stop(){g.store(),clearMask(),g.$content.resize()},minWidth:this.options.min_width,minHeight:this.options.min_height}),this.$resize_hanles=$('.ui-resizable-handle',this.$win)),this.$close&&this.$close.click(function(){g.close()}),this.$max&&this.$max.click(function(){g.max()}),this.$min&&(this.$min.click(function(){g.min()}),this.addTask());var C=function _e(z){z.stopPropagation(),z.preventDefault()};this.$win.mousedown(function(){g.options.desktop||g.active()}).on('dragover',function(z){return $('.win.frame.active').addClass('dragover'),C(z)}).on('dragenter',function(z){return C(z)}).on('dragleave',function(z){return C(z)}).on('drop',function(z){return C(z),$('.win.frame.active').removeClass('dragover'),g.frameWindow&&g.frameWindow.drop&&g.frameWindow.drop(z),!1}),this.$container.show()}},{key:'load',value:function load(){var g=this;this.options.url&&''!==this.options.url?(this.$win.addClass('frame'),this.$content.remove(),this.$frame.attr('src',this.options.url).on('load',function(){g.frameWindow=g.$frame[0].contentWindow,g.frameWindow.OS=OS,g.frameWindow.WINDOW=g,g.frameWindow.init&&g.frameWindow.init()})):(this.$frame.remove(),this.$content.empty().append(this.options.content)),this.options.onload&&this.options.onload(this)}},{key:'close',value:function close(){0<this.$modal.children().length||(this.options.onclose&&this.options.onclose(this),this.prev&&(OS.desktop.curwin=null,this.prev.active()),this.$container.parent()[0]===document.body&&this.$container.hasClass('modal')&&this.$container.hide(),this.closed=!0,this.$win.remove(),this.removeTask(),this.app&&this.app.win&&delete this.app.win,delete this)}},{key:'active',value:function active(){return($('body').removeClass('taskview'),$('.win.app').css({transform:'none',position:'fixed'}).each(function(){this.originalPosition&&($(this).css({overflow:'visible',left:this.originalPosition.left,top:this.originalPosition.top}),!this.originalPosition.visible&&$(this).hide(),delete this.originalPosition)}),$('.win.dragover').removeClass('dragover'),this.$container.data().stack&&0!==this.$container.children().length||(this.$container.data().stack=0),this.$win.css({zIndex:this.$container.data().stack++}),0<this.$modal.children().length)?void $('.win:last',this.$modal).addClass('active').show():void((this.$win.addClass('active').show(),this.app!==OS)&&(OS.desktop.show(),this.$container.show(),OS.desktop.curwin===this||(this.prev=OS.desktop.curwin||this.prev,this.prev&&this.prev.deactive(),OS.desktop.curwin=this,this.activeTask())))}},{key:'deactive',value:function deactive(){this.$win.removeClass('active')}},{key:'show',value:function show(){this.$win.show()}},{key:'hide',value:function hide(){this.$win.hide()}},{key:'store',value:function store(){this.state_data={width:this.$win.width(),height:this.$win.height(),left:this.$win.position().left,top:this.$win.position().top}}},{key:'max',value:function max(){return 2===this.state?void this.restore():void(this.state=2,this.store(),this.$max&&this.$max.addClass('restore'),this.$win.addClass('maxed'),this.$resize_hanles&&this.$resize_hanles.hide(),$(window).resize(),this.$content.resize())}},{key:'restore',value:function restore(){this.state=0,this.$max.removeClass('restore'),this.$win.removeClass('maxed').css(this.state_data),this.$resize_hanles&&this.$resize_hanles.show(),$(window).resize(),this.$content.resize()}},{key:'min',value:function min(){this.deactive(),this.$win.hide(),this.deactiveTask()}},{key:'addTask',value:function addTask(){OS.desktop.panel.addTask(this)}},{key:'removeTask',value:function removeTask(){OS.desktop.panel.removeTask(this)}},{key:'activeTask',value:function activeTask(){OS.desktop.panel.activeTask(this)}},{key:'deactiveTask',value:function deactiveTask(){OS.desktop.panel.deactiveTask(this)}},{key:'setCaption',value:function setCaption(g){this.$caption.html(g),this.caption=g}}]),win}(),dialog_win=function(g){function _(C){if(_classCallCheck(this,_),C=$.extend({caption:'Dialog',type:'modal',min_button:!1,max_button:!1,parent:OS.desktop.win},C),C.parent&&(C.app=C.parent.app),C.url&&C.parent&&(C.url=C.parent.app.path+C.url),C.content){var z=$(document.createElement('div'));z.addClass(C.classname||'').append(C.content);var E=$(document.createElement('div'));if(C.buttons)E.append(C.buttons);else{var P=$(document.createElement('button'));P.html($.l10n.__('ok')),P.click(function(){C.callback()&&M.close()});var T=$(document.createElement('button'));T.html($.l10n.__('cancel')),T.click(function(){M.close()}),E.append([P,T])}C.content=[z,E]}var M=_possibleConstructorReturn(this,(_.__proto__||Object.getPrototypeOf(_)).call(this,{},C));return M.$content.addClass('dialog').addClass(C.classname||''),C.content&&(M.$dialog=z,M.$buttons=E,E.css({position:'absolute',width:'100%',bottom:0,overflow:'hidden'}),z.css({position:'absolute',overflow:'auto',width:'100%',height:'calc(100% - '+E.height()+'px',boxSizing:'border-box'})),M}return _inherits(_,g),_}(win),alert_win=function(g){function _(C){_classCallCheck(this,_);var z=$(document.createElement('button'));z.html($.l10n.__('ok')),'object'===('undefined'==typeof C?'undefined':_typeof(C))?(!C.content&&(C.content=''),'string'!=typeof C.content&&(C.content+='')):C={content:C+''},C=$.extend({caption:$.l10n.__('alert'),center:!0,width:500,height:250,buttons:z,popup:!0},C);var E=_possibleConstructorReturn(this,(_.__proto__||Object.getPrototypeOf(_)).call(this,C));return E.$content.addClass('alert'),E.$dialog.css({display:'box',boxAlign:'center',boxPack:'center',padding:24,textAlign:'center'}),z.click(function(){E.close()}),E}return _inherits(_,g),_}(dialog_win),confirm_win=function(g){function _(C){_classCallCheck(this,_);var z=$(document.createElement('button'));z.html($.l10n.__('ok'));var E=$(document.createElement('button'));E.html($.l10n.__('cancel')),C=$.extend({caption:$.l10n.__('confirm'),center:!0,width:400,height:250,min_button:!1,max_button:!1,buttons:[z,E],popup:!0},C);var P=_possibleConstructorReturn(this,(_.__proto__||Object.getPrototypeOf(_)).call(this,C));return P.$content.addClass('confirm'),P.$dialog.css({display:'box',boxAlign:'center',boxPack:'center',padding:24,textAlign:'center'}),z.click(function(){C.callback&&C.callback(P),C.keep||P.close()}),E.click(function(){P.close()}),P}return _inherits(_,g),_}(dialog_win),prompt_win=function(g){function _(C){_classCallCheck(this,_);var z=$(document.createElement('button'));z.html($.l10n.__('ok'));var E=$(document.createElement('button'));E.html($.l10n.__('cancel'));var P=$(document.createElement('input'));P.attr('type','text').width('100%').val(C.content).keypress(function(S){13===S.which&&z.click()});var T=$(document.createElement('div'));T.css({textAlign:'left'}).html(C.pre||'').append(P),C=$.extend({caption:$.l10n.__('prompt'),center:!0,width:400,height:180,min_button:!1,max_button:!1,buttons:[z,E],popup:!0,callback:function callback(){C.callback&&C.callback(P.val())}},C),C.content=T;var M=_possibleConstructorReturn(this,(_.__proto__||Object.getPrototypeOf(_)).call(this,C));return M.$dialog.css({display:'box',boxAlign:'center',boxPack:'center',padding:24,textAlign:'center'}),z.click(function(){C.callback&&C.callback(P.val()),M.close()}),E.click(function(){M.close()}),M}return _inherits(_,g),_}(dialog_win),progress_win=function(g){function _(C){_classCallCheck(this,_);var z=$(document.createElement('button'));z.html($.l10n.__('cancel'));var E=$(document.createElement('progress'));E.width('100%').val(0);var P,T=setInterval(function(){var O=E.val()-0;0>=O&&(P=.01),1<=O&&(P=-.01),O+=P,E.val(O)},10),M=$(document.createElement('div'));M.html(C.content),C=$.extend({caption:$.l10n.__('progress'),center:!0,width:400,height:180,min_button:!1,max_button:!1,buttons:[z],popup:!0,onclose:function onclose(){return clearInterval(T)}},C),C.content=[E,M];var S=_possibleConstructorReturn(this,(_.__proto__||Object.getPrototypeOf(_)).call(this,C));return S.$dialog.css({display:'box',boxAlign:'center',boxPack:'center',padding:24,textAlign:'center'}),S.setProgress=function(O){clearInterval(T),E.val(O)},S.setText=function(O){return M.html(O)},S.$content.addClass('progress'),C.callback&&C.callback(),z.click(function(){S.close()}),S}return _inherits(_,g),_}(dialog_win),fileManager=function(){function g(_,C){var z=this;_classCallCheck(this,g),_||(_={}),C||(C=OS.desktop.win),this.path=_.path||(_.isdesktop?'desktop:///':'root:///'),this.history=[],this.historyIndex=null,this.win=C,this.isdesktop=_.isdesktop,this.options=_,this.showhidden=!1,this.order='asc',this.by='name',this.parent=this.win.parent,this.win.options&&(this.win.options.onclose=function(){OS.path.delWin(z.win)}),_.filter&&'folder'===_.filter&&(this.choosefolder=!0),OS.path.addWin(this),setTimeout(function(){z.choosefolder?z.drawTree():z.draw()},5)}return _createClass(g,[{key:'draw',value:function draw(){var _=this,T=this.win.$content;this.isdesktop&&T.addClass('desktop');var M=$(document.createElement('div')),S=$(document.createElement('div')),O=$(document.createElement('div')),I=$(document.createElement('div')),D=$(document.createElement('div')),N=$(document.createElement('div')),Y=$(document.createElement('div'));this.options.button||S.appendTo(M).addClass('menubar').menu({app:'FileManager',menu:{file:{child:{newfolder:function newfolder(){return _.newfolder()},upload:function(G){return _.upload(G)},download:function download(G){return _.download(G)}}},edit:{child:{copy:function copy(){return _.copy()},cut:function cut(){return _.cut()},paste:function paste(){return _.paste()},pastelink:function pastelink(){return _.pastelink()},rename:function rename(){return _.rename()},del:function del(G,R){return _.del(G,R)},cleartrashbin:function cleartrashbin(){return _.cleartrashbin()},properties:function properties(){return _.properties()}}},view:{child:{orderby:{child:{orderbyname:function orderbyname(){return _.orderby('name')},orderbytype:function orderbytype(){return _.orderby('type')},orderbysize:function orderbysize(){return _.orderby('size')},orderbymtime:function orderbymtime(){return _.orderby('mtime')}}},showhiddenfile:function showhiddenfile(){return _.showHidden()},refresh:function refresh(){return _.refresh()}}}}}),this.isdesktop?T.append(D):T.append([M,I,D,this.options.button?Y:N]).layout({center:{pane:D},north:{pane:M,size:this.options.button?30:54},south:{pane:this.options.button?Y:N,size:this.options.button?130:20},west:isMobile?null:{pane:I,size:250,resizable:!0}}),isMobile&&I.hide(),O.appendTo(M).addClass('toolbar').html('<div class="back disabled"></div><div class="forward disabled"></div><div class="up disabled"></div><div class="refresh"></div><div class="path"><div></div><input type="text" style="display:none;border:none;width:100%;height:100%;"></div>'+(this.options.button?'':'<div class="search"><div><input type="text" value="" placeholder="'+$.l10n.__('search')+'"/></div></div>')+'</div></div>'),I.addClass('side left').css({overflow:'auto'}).html('<ul class="filetree"><li><a path="root:///" style="display:none;"></a><a>'+$.l10n.__('places')+'</a><ul><li><a path="home:///" class="home dir">'+USERINFO.name+'</a></li><li><a path="desktop:///" class="desktop dir">'+$.l10n.__('desktop')+'</a></li><li><a path="file:///" class="computer dir">'+$.l10n.__('computer')+'</a></li><li><a path="trash:///" class="trash dir">'+$.l10n.__('trash')+'</a></li></ul></li><li><a>'+$.l10n.__('devices')+'</a><ul class="devices"></ul></li><li><a>'+$.l10n.__('shared')+'</a><ul><li><a path="public:///" class="public dir">'+$.l10n.__('public')+'</a></li></ul>').selected({filter:'ul ul a',single:!0,selected:function selected(G){return _.load(G.target.getAttribute('path'),null,!0)}}),D.addClass('main').css({overflow:'auto'}).menu({contextmenu:!0,app:'FileManager',onload:function onload(G){return _.setMenu(G)},menu:{newfolder:function newfolder(){return _.newfolder()},paste:function paste(){return _.paste()},pastelink:function pastelink(){return _.pastelink()},properties:function properties(){return _.properties()},cleartrashbin:function cleartrashbin(){return _.cleartrashbin()},refresh:function refresh(){return _.refresh()}}}).html('<table cellspacing="0" cellpadding="0" class="filelist iconlist '+(this.isdesktop?'small':'')+'"><thead><tr><th class="name">'+$.l10n.__('filename')+'</th><th class="type">'+$.l10n.__('filetype')+'</th><th class="size">'+$.l10n.__('filesize')+'</th><th class="mtime">'+$.l10n.__('mtime')+'</th></tr></thead><tbody></tbody></table>').on('mousedown','th',function(G){_.orderby(G.target.className)}).selected({filter:'tbody tr',single:this.options.single,selected:function selected(G){return _.setMenu(G)}}),this.isdesktop&&D.css({width:'100%',height:'100%',overflow:'visible',display:'flex'}),N.addClass('statusbar').html('<div class="status"><span class="items"></span><span class="selecteditems"></span><span class="usage"></span></div><div class="icon tablelist"></div><div class="icon iconlist ui-selected"></div>').selected({filter:'.icon',single:!0}),Y.html('<table width="100%"><tr><td>'+$.l10n.__('filename')+'</td><td><input class="filename" value="'+(this.options.filename||'')+'"/></td></tr><tr><td>'+$.l10n.__('filetype')+'</td><td><select class="filetype"></select></td></tr><tr><td colspan="2" align="right"><button class="'+this.options.button+'">'+$.l10n.__(this.options.button)+'</button><button class="cancel">'+$.l10n.__('cancel')+'</button></td></tr></table>'),this.$status=$('.status',N),this.$status.css({textAlign:'left'}),this.$status_items=$('.status .items',N),this.$status_selecteditems=$('.status .selecteditems',N),this.$status_usage=$('.status .usage',N),this.$back=$('.back',M),this.$back.click(function(){return _.back()}),this.$forward=$('.forward',M),this.$forward.click(function(){return _.forward()}),this.$up=$('.up',O),this.$up.click(function(){return _.up()}),this.$refresh=$('.refresh',O),this.$refresh.click(function(){return _.refresh()}),this.$showhiddenfile=$('.menu [name="showhiddenfile"]',T),this.$orderby=$('.menu [name^="orderby"]',T),this.$orderbyname=$('.menu [name="orderbyname"]',T),this.$orderbytype=$('.menu [name="orderbytype"]',T),this.$orderbysize=$('.menu [name="orderbysize"]',T),this.$orderbymtime=$('.menu [name="orderbymtime"]',T),this.$content=$('tbody',D),this.$content.menu({contextmenu:!0,app:'FileManager',target:'tr',onload:function onload(G){return _.setMenu(G)},menu:{open:function open(G){return _.openFolder(G)},cut:function cut(){return _.cut()},copy:function copy(){return _.copy()},rename:function rename(){return _.rename()},del:function del(G,R){return _.del(G,R)},setbackground:function setbackground(G,R){return _.setbackground(G,R)},zip:function zip(G,R){return _.zip(G,R)},unzip:function unzip(G,R){return _.unzip(G,R)},cleartrashbin:function cleartrashbin(){return _.cleartrashbin()},properties:function properties(){return _.properties()}}}).on('dblclick','tr',function(G){return _.openFolder(G)});var L=function _e(G){return G.preventDefault(),G.stopPropagation(),!1};if(this.win.$win.on('drop',function(G){return _.drop(G),L(G)}),this.isdesktop&&(this.$content.css({display:'flex',flexDirection:'column',flexWrap:'wrap',alignContent:'start'}),$(window).resize(function(){_.$content.css({width:$('body').width(),height:$('body').height()})}).resize()),this.$side=I,this.$filelist=$('.filelist',D),this.$devices=$('.devices',I),this.$container=T,this.$tablelist=$('.tablelist',N),this.$tablelist.click(function(){return _.$filelist.removeClass('iconlist').addClass('tablelist')}),this.$iconlist=$('.iconlist',N),this.$iconlist.click(function(){return _.$filelist.removeClass('tablelist').addClass('iconlist')}),this.$path=$('.path div',O),this.$pathinput=$('.path input',O),this.$path.on('click','span',function(G){G.stopPropagation(),_.load(G.target.getAttribute('path'),null,!0)}),this.$path.on('click',function(){_.$pathinput.val(_.path).show(),_.$path.hide()}),this.$pathinput.on('keypress',function(G){13==G.which&&(_.$pathinput.hide(),_.$path.show(),!/\/$/.test(_.$pathinput.val())&&_.$pathinput.val(_.$pathinput.val()+'/'),_.load(_.$pathinput.val(),null,!0))}),this.$search=$('.search',O),this.$pattern=$('.search input',O),this.$pattern.on('keypress',function(G){return _.find(G)}),this.$open=$('button.open',Y),this.$save=$('button.save',Y),this.$openfiles=$('input.filename',Y),this.$open.click(function(){return _.openFiles()}),this.$save.click(function(){return _.saveFile()}),this.$cancel=$('button.cancel',Y),this.$cancel.click(function(){return _.win.close()}),this.$filters=$('select',Y),this.options.button)for(var U in this.options.filter||(this.options.filter={}),this.options.filter[$.l10n.__('alltypes')]=['*'],this.options.filter){var X=this.options.filter[U];this.$filters.append('<option value=".file.'+X.join(',.file.')+'">'+U+'(*.'+X.join(',*.')+')</option>'),this.$filters.change(function(){return'.file.*'===_.$filters.val()?void $('.file',_.$content).show():void($('.file',_.$content).hide(),$(_.$filters.val(),_.$content).show())})}this.path&&this.load(this.path,!0,!0)}},{key:'drawTree',value:function drawTree(){var _=this,C=this.win.$content,z=$(document.createElement('div')),E=$(document.createElement('div')),P=$(document.createElement('button')),T=$(document.createElement('button'));E.css({position:'absolute',width:'100%',height:60,bottom:0}),E.append([P,T]),P.html($.l10n.__('ok')).click(function(){_.options.callback(_.path)&&_.win.close()}),T.html($.l10n.__('cancel')).click(function(){return _.win.close()}),z.css({position:'absolute',width:'100%',height:'calc(100% - 60px)',overflow:'auto'}),C.append([z,E]),z.html('<ul class="filetree"><li><a>'+$.l10n.__('places')+'</a><ul><li><a path="home:///" class="home dir">'+$.l10n.__('home')+'</a></li><li><a path="desktop:///" class="desktop dir">'+$.l10n.__('desktop')+'</a></li><li><a path="file:///" class="computer dir">'+$.l10n.__('computer')+'</a></li></ul></li><li><a>'+$.l10n.__('shared')+'</a><ul><li><a path="public:///" class="public dir">'+$.l10n.__('public')+'</a></li></ul>').selected({filter:'ul ul a',single:!0,selected:function selected(M){return _.load(M.target.getAttribute('path'),null,!0)}}),this.$content=$('>ul',z),this.$content.on('click','a',function(M){_.load(M.currentTarget.getAttribute('path'))}),this.path&&this.load(this.path,!0,!0)}},{key:'refresh',value:function refresh(_){OS.clipboard=null,_||(_=this.path),'string'==typeof _&&(_=[_]);var C=!0,z=!1,E=void 0;try{for(var T,M,P=_[Symbol.iterator]();!(C=(T=P.next()).done);C=!0)M=T.value,OS.path.ls({data:{path:M,showhidden:this.showhidden},waiting:this.win.$waiting,win:this})}catch(S){z=!0,E=S}finally{try{!C&&P.return&&P.return()}finally{if(z)throw E}}}},{key:'load',value:function load(_,C,z){if(_||(_=this.path,C=!1),!0===_&&(_=this.path,C=!0),/\/$/.test(_)||(_=OS.path.dirname(_)),!OS.path.storage[_]||OS.path.storage[_]&&!OS.path.storage[_].children)var C=!0;if(this.path=_,this.choosefolder||(this.setPlace(),this.setMenu(),this.setPath(_),!this.options.button&&(this.setCaption(_),this.setSearch(_)),z&&this.checkHistory()),this.$search&&('root:///'===this.path||'trash:///'===this.path||0===this.path.indexOf('share:///')?this.$search.hide():this.$search.show()),C)OS.path.ls({data:{path:_,showhidden:this.showhidden},waiting:this.win.$waiting,win:this}),this.isdesktop&&this.parse({});else{var E=OS.path.getStorage(_);this.parse(E)}}},{key:'parse',value:function parse(_){var C=this;if(this.choosefolder)return this.parseTree(_);this.$content.empty();var z=_.children||[],E=OS.path.getUsage(this.path);this.setStatus({items:z.length,usage:E||(_.prop?_.prop[13]:'')}),this.isdesktop&&this.$content.append('<tr path="file:///" class="dir computer" draggable="true"><td class="fileicon"><div></div>'+$.l10n.__('computer')+'</td></tr><tr path="trash:///" class="dir trash" draggable="true"><td class="fileicon"><div></div>'+$.l10n.__('trash')+'</td></tr>');var P=!0,T=!1,M=void 0;try{for(var O,S=z[Symbol.iterator]();!(P=(O=S.next()).done);P=!0){var I=O.value,D=I[8],N=OS.path.getProp(D,I),Y=N.name,L=N.type,U=N.sizestr,X=N.mtimestr,G=N.title+(N.isdisk?' ('+N.name+')':''),R=N.classname,V=N.thumbnail;this.$content.append('<tr draggable="true" path="'+D+'" class="'+R+'"><td class="fileicon"><div '+(V?'style="background-image:url(\''+V+'\')"':'')+'></div>'+G+'</td><td>'+L+'</td><td>'+U+'</td><td>'+X+'</td></tr>')}}catch(K){T=!0,M=K}finally{try{!P&&S.return&&S.return()}finally{if(T)throw M}}$('tr',this.$content).on('dragstart',function(K){var Q=$(K.currentTarget);Q.addClass('ui-draggable-dragging');var J=$('.ui-selected>td.fileicon>div',C.$content),Z=[],ee=[],te=!0,ae=!1,ne=void 0;try{for(var oe,ie,se=J[Symbol.iterator]();!(te=(oe=se.next()).done);te=!0)ie=oe.value,ee.push(ie.parentNode.parentNode.getAttribute('path')),Z.push(getComputedStyle(ie).getPropertyValue('background-image'))}catch(re){ae=!0,ne=re}finally{try{!te&&se.return&&se.return()}finally{if(ae)throw ne}}OS.desktop.draghelper.style.backgroundImage=Z.join(','),K.originalEvent.dataTransfer.setDragImage(OS.desktop.draghelper,0,0),K.originalEvent.dataTransfer.setData('path',JSON.stringify(ee))}).on('dragover',function(){$(this).hasClass('dir')&&$(this).addClass('ui-dragover')}).on('dragleave',function(){$(this).removeClass('ui-dragover')}).on('dragend',function(K){$(K.currentTarget).removeClass('ui-dragover'),$(K.target).removeClass('ui-draggable-dragging')}).on('drop',function(K){return K.stopPropagation(),K.preventDefault(),$(K.currentTarget).removeClass('ui-dragover'),OS.desktop.draghelper.style.backgroundImage='none',C.drop(K),!1}),this.$filters.change(),this.parseDevices(),OS.path.trash()}},{key:'parseTree',value:function parseTree(_){var C=_.children||[];if(0!==C.length){var z=$('a[path="'+this.path+'"]',this.$content);z.next().remove();var E=$(document.createElement('ul'));E.addClass('treeview'),z.after(E);var P=!0,T=!1,M=void 0;try{for(var O,S=C[Symbol.iterator]();!(P=(O=S.next()).done);P=!0){var I=O.value,D=I[8],N=OS.path.getProp(D);!N.isdir||'file:///'===this.path&&!N.ismount||E.append('<li><a class="'+N.classname+'" path="'+D+'">'+N.title+(N.isdisk?' ('+N.name+')':'')+'</a></li>')}}catch(Y){T=!0,M=Y}finally{try{!P&&S.return&&S.return()}finally{if(T)throw M}}}}},{key:'parseDevices',value:function parseDevices(){if(!this.isdesktop){var _=OS.path.storage['file:///'].children,C=$('.ui-selected',this.$side).attr('path');this.$devices.empty();var z=!0,E=!1,P=void 0;try{for(var M,T=_[Symbol.iterator]();!(z=(M=T.next()).done);z=!0){var S=M.value,O=S[8],I=OS.path.getProp(O,S);if(I.ismount){var D=I.udev,N=I.title+(I.isdisk?' ('+I.name+')':''),Y=I.classname,L=I.name;this.$devices.append('<li name="'+L+'"><a path="'+O+'" class="'+Y+' dir '+(O==C?'ui-selected':'')+'">'+N+'</a><li>')}}}catch(U){E=!0,P=U}finally{try{!z&&T.return&&T.return()}finally{if(E)throw P}}}}},{key:'openFolder',value:function openFolder(_){if('trash:///'!==this.path){var C=$(_.currentTarget),z=C.attr('path');if(this.isdesktop&&C.hasClass('dir'))return void OS.FileManager.load({path:z});var E=OS.path.getProp(z);return E&&E.isfile?void(this.options.button?this.openFiles():this.openFile(z)):void this.load(z,null,!0)}}},{key:'openFile',value:function openFile(_){OS.path.open(_)}},{key:'openFiles',value:function openFiles(){var _=this.getSelected('.file');0===_.length||(this.options.single&&(_=_[0]),this.options.callback(_),this.win.close())}},{key:'saveFile',value:function saveFile(){var _=this,C=this.$openfiles.val(),z=validFilename(C);if(z){var E=this.path+z,P=function _c(){var T=_.options.callback;_.win.close(),T(E)};OS.path.exists({path:E,success:function success(){return _.win.confirm($.l10n.__('replaceexistedfile'),function(){return P()})},error:function error(){return P()}})}}},{key:'setMenu',value:function setMenu(_){var C=this.path,z=this.getSelected(),E=_?$(_.currentTarget):null;$('.disabled','.FileManager.menu').removeClass('disabled');var P=$('[name="download"],[name="copy"],[name="cut"],[name="rename"],[name="del"],[name="setbackground"],[name="zip"],[name="unzip"]','.FileManager.menu');0<z.length?P.removeClass('disabled'):P.addClass('disabled');var T=$('[name="setbackground"]','.FileManager.menu');_&&E.hasClass('image')?T.show():T.hide();var M=$('[name="unzip"]','.FileManager.menu');_&&E.hasClass('zip')?M.show():M.hide();var S=$('[name="paste"],[name="pastelink"]','.FileManager.menu');OS.clipboard&&'file'===OS.clipboard.type?S.removeClass('disabled'):S.addClass('disabled');var O=$('[name="newfolder"],[name="download"],[name="upload"],[name="cut"],[name="paste"],[name="pastelink"],[name="del"],[name="zip"],[name="unzip"]','.FileManager.menu');('file:///'===this.path||'root:///'===this.path)&&O.addClass('disabled');var I=$('[name="open"],[name="newfolder"],[name="upload"],[name="rename"],[name="paste"],[name="pastelink"],[name="setbackground"],[name="zip"],[name="unzip"]','.FileManager.menu');0===this.path.indexOf('trash:///')&&(I.addClass('disabled'),0===z.length&&$('[name="properties"]','.FileManager.menu').addClass('disabled'));var D=_?E.attr('path'):null,N=$('[name="rename"],[name="copy"],[name="cut"],[name="del"],[name="setbackground"],[name="zip"],[name="unzip"],[name="properties"]','.FileManager.contextmenu');'trash:///'===D&&N.addClass('disabled');var Y=$('[name="rename"],[name="copy"],[name="cut"],[name="del"],[name="setbackground"],[name="zip"],[name="unzip"]','.FileManager.contextmenu');'file:///'===D&&Y.addClass('disabled');var L=$('[name="cleartrashbin"]','.FileManager.menu');if(0===this.path.indexOf('trash:///')||'trash:///'===D?L.show():L.hide(),this.options.button){if('open'===this.options.button){var U=[],X=!0,G=!1,R=void 0;try{for(var K,Q,V=this.getSelected('.file')[Symbol.iterator]();!(X=(K=V.next()).done);X=!0)Q=K.value,U.push(OS.path.basename(Q))}catch(J){G=!0,R=J}finally{try{!X&&V.return&&V.return()}finally{if(G)throw R}}this.$openfiles.val(1===U.length?U[0]:JSON.stringify(U).replace(/^\[/,'').replace(/\]$/,'').replace('","',''))}'save'===this.options.button&&this.$openfiles.val(OS.path.basename(this.getSelected('.file')[0]||''))}'root:///'===C&&$('[name="rename"],[name="cut"],[name="del"],[name="zip"]','.FileManager.contextmenu').addClass('disabled')}},{key:'setPlace',value:function setPlace(){var _=this,C=function set(E){var P=OS.path.dirname(E),T=$('[path="'+E+'"]',_.$side);T[0]?($('a.ui-selected',_.$side).removeClass('ui-selected'),T.addClass('ui-selected')):C(P)},z=this.path;C(z),'root:///'===z?this.$up.addClass('disabled'):this.$up.removeClass('disabled')}},{key:'setPath',value:function setPath(_){var C=OS.path.split(_),z=C.length,E=C[0],P=C[1],T=['<span></span>'],_='';if(''===P){var M='';M='file://'===E?$.l10n.__('computer'):'home://'===E?USERINFO.name:$.l10n.__(E.replace('://','')),_=E+'/',T.push('<span path="'+_+'">'+M+'</span>')}else{_=E+P+'/';var S=P.split('@');1<S.length?T.push('<span path="'+_+'">'+S[1]+'</span>'):T.push('<span path="'+_+'">'+P+'</span>')}for(var O=2;O<z;O++){var M=C[O],I=M;_+=I+'/',T.push('<span path="'+_+'">'+M+'</span>')}T=T.join(''),this.$path.html(T).show(),this.$pathinput.hide()}},{key:'setCaption',value:function setCaption(_){var C=$('[path="'+_+'"]',this.$side),z=C[0]?C.text():OS.path.basename(_);this.win.setCaption&&this.win.setCaption(z)}},{key:'setSearch',value:function setSearch(_){var C=OS.path.getProp(_);C&&this.$pattern.attr('placeholder',$.l10n.__('search')+' "'+C.title+'"')}},{key:'setStatus',value:function setStatus(_){return _?('undefined'!=typeof _.items&&(''===_.selected?this.$status_items.empty():this.$status_items.html($.l10n.__('totalitems').replace('{0}',_.items))),-1<$.inArray(this.path,['root:///','file:///','trash:///','share:///'])?void this.$status_usage.empty():void('undefined'!=typeof _.selected&&(''===_.selected?this.$status_selecteditems.empty():this.$status_selecteditems.html($.l10n.__('selecteditems').replace('{0}',_.selected))),'undefined'!=typeof _.items&&(''===_.usage?this.$status_usage.empty():this.$status_usage.html($.l10n.__('diskusage').replace('{0}',bytesToSize(_.usage.size)).replace('{1}',bytesToSize(_.usage.used)).replace('{2}',bytesToSize(_.usage.avail)))))):(this.$status_items.empty(),this.$status_selecteditems.empty(),void this.$status_usage.empty())}},{key:'showHidden',value:function showHidden(){var _=this.$showhiddenfile;_.toggleClass('checked'),this.showhidden=!!_.hasClass('checked'),this.load(!0)}},{key:'getSelected',value:function getSelected(_){var C=$('tr.ui-selected'+(_||''),this.$content),z=[],E=!0,P=!1,T=void 0;try{for(var S,O,M=C[Symbol.iterator]();!(E=(S=M.next()).done);E=!0)O=S.value,z.push(O.getAttribute('path'))}catch(I){P=!0,T=I}finally{try{!E&&M.return&&M.return()}finally{if(P)throw T}}return z}},{key:'checkHistory',value:function checkHistory(){var _=this.history[this.history.length-1];_===this.path||(this.$forward.addClass('disabled'),null!==this.historyIndex&&(this.history=this.history.slice(0,this.historyIndex+2)),this.history.push(this.path),this.historyIndex=this.history.length-1,1<this.history.length&&this.$back.removeClass('disabled'))}},{key:'orderby',value:function orderby(_){_||(_=this.by),_!==this.by&&(this.order='acs');var C=this.order,z=$('tr',this.$content);z.sort(function(E,P){var T=OS.path.getProp(E.getAttribute('path'))[_],M=OS.path.getProp(P.getAttribute('path'))[_];return'string'==typeof T&&(T=T.toLowerCase()),'string'==typeof M&&(M=M.toLowerCase()),'acs'===C?T>M?1:T<M?-1:0:T>M?-1:T<M?1:0}),this.$orderby.removeClass('checked'),this['$orderby'+_].addClass('checked'),this.order='acs'===C?'desc':'acs',this.by=_,z.appendTo(this.$content)}},{key:'back',value:function back(){if(!this.$back.hasClass('disabled')){null===this.historyIndex&&(this.historyIndex=this.history.length-1),this.historyIndex--,0===this.historyIndex&&this.$back.addClass('disabled'),this.$forward.removeClass('disabled');var _=this.history[this.historyIndex];this.load(_)}}},{key:'forward',value:function forward(){if(!this.$forward.hasClass('disabled')){this.historyIndex++,this.historyIndex===this.history.length-1&&this.$forward.addClass('disabled'),this.$back.removeClass('disabled');var _=this.history[this.historyIndex];this.load(_)}}},{key:'up',value:function up(){if(!this.$up.hasClass('disabled')){for(var C,_=this.path;!C&&'root:///'!==_;)_=OS.path.dirname(_),C=OS.path.storage[_];this.checkHistory(),this.load(_)}}},{key:'copy',value:function copy(){var _=this.getSelected();0===_.length||(OS.clipboard={type:'file',data:{action:'copy',data:_}},this.setMenu())}},{key:'cut',value:function cut(){var _=this.getSelected();0===_.length||(OS.clipboard={type:'file',data:{action:'cut',data:_}},this.setMenu())}},{key:'pastelink',value:function pastelink(_,C){_||(_=OS.clipboard);var z=_.data.data;C=_.data.path||this.path,OS.path.ln({data:{path:z,newpath:C}})}},{key:'paste',value:function paste(_){var C=this;if(-1<$.inArray(this.path,['file:///','shared:///']))return!1;if(_||(_=OS.clipboard),'file'!==_.type)return!1;var z=_.data.path||this.path,E=_.data;if(0!==E.data.length){var P=E.data,T=[],M=!0,S=!1,O=void 0;try{for(var D,I=P[Symbol.iterator]();!(M=(D=I.next()).done);M=!0){var N=D.value,Y=OS.path.isdir(N);'cut'===E.action?OS.path.dirname(N)!==z&&!(0===z.indexOf(N)&&Y)&&-1===$.inArray(N,['trash:///','home:///','file:///','root:///','share:///'])&&T.push(N):!(0===z.indexOf(N)&&Y)&&T.push(N)}}catch(U){S=!0,O=U}finally{try{!M&&I.return&&I.return()}finally{if(S)throw O}}if(0===T.length)return!1;var L=function c(U){'string'==typeof U&&C.win.alert(U)};'cut'===E.action&&(OS.clipboard=null,this.setMenu(),OS.path.mv({data:{path:T,newpath:z},success:L,error:L})),'copy'===E.action&&OS.path.cp({data:{path:T,newpath:z},error:L})}}},{key:'newfolder',value:function newfolder(){var _=this;(this.win.prompt||OS.prompt)($.l10n.__('foldername'),'','',function(C){var z=validFilename(C);return z?void(z=_.path+(/\/$/.test(_.path)?'':'/')+z,OS.path.mkdir({data:{path:z}})):void _.win.alert($.l10n.__('invalidfilename'))})}},{key:'del',value:function del(_,C){var z=this.getSelected(),E='trash:///'===this.path||C&&C.shiftKey,P=$.l10n.__(E?'delitems':'trashitems');this.win.confirm(P,function(){E?OS.path.rm({data:{path:z}}):OS.path.mv({data:{path:z,newpath:'trash:///'}})})}},{key:'rename',value:function rename(){var _=this,C=this.getSelected(),z=OS.path.getProp(C[0]),E=z.title||z.name;this.win.prompt($.l10n.__('filename'),'',E,function(P){return P?void OS.path.mv({data:{path:C,newpath:P}}):void _.win.alert($.l10n.__('invalidfilename'))})}},{key:'find',value:function find(_){var C=this;if(13===_.keyCode){var z=$.trim(this.$pattern.val());OS.path.find({data:{path:this.path,file:z},success:function success(E){return C.parse(E)}})}}},{key:'zip',value:function zip(){var _=this.getSelected();OS.path.zip({data:{file:JSON.stringify(_),path:this.path}})}},{key:'unzip',value:function unzip(_){var z=$(_.currentTarget),E=z.attr('path');OS.path.unzip({data:{path:E}})}},{key:'setbackground',value:function setbackground(_){var z=$(_.currentTarget),E=z.attr('path');OS.desktop.background(E)}},{key:'cleartrashbin',value:function cleartrashbin(){this.win.confirm($.l10n.__('delitems'),function(){OS.path.cleartrash()})}},{key:'properties',value:function properties(){var _=this.getSelected();0===_.length&&(_=[this.path]);var C=_[0];OS.Properties.load({path:C},{id:'properties_'+OS.path.getProp(C).inode,max_button:!1,resizable:!1})}},{key:'upload',value:function(_,C){var z=this;if(C){var E=[],P=!0,T=!1,M=void 0;try{for(var O,I,S=_[Symbol.iterator]();!(P=(O=S.next()).done);P=!0)I=O.value,E.push(I.webkitGetAsEntry())}catch(X){T=!0,M=X}finally{try{!P&&S.return&&S.return()}finally{if(T)throw M}}this.readLocal(E,C,function(X){return OS.Upload.load({file:X,path:C,win:z})})}else{var D=!0,N=!1,Y=void 0;try{for(var U,I,L=_[Symbol.iterator]();!(D=(U=L.next()).done);D=!0)I=U.value,I.href=this.path+I.name,OS.Upload.load({file:I,path:this.path,win:this})}catch(X){N=!0,Y=X}finally{try{!D&&L.return&&L.return()}finally{if(N)throw Y}}}}},{key:'download',value:function download(){var C=this.getSelected(),z=!0,E=!1,P=void 0;try{for(var M,S,T=C[Symbol.iterator]();!(z=(M=T.next()).done);z=!0)S=M.value,/\/$/.test(S)||window.open(DOMAIN+S,'_blank')}catch(O){E=!0,P=O}finally{try{!z&&T.return&&T.return()}finally{if(E)throw P}}}},{key:'drop',value:function drop(_){var z=$(_.currentTarget),E=z.hasClass('dir')?z.attr('path'):this.path;if(-1<$.inArray(E,['file:///','shared:///']))return!1;var P=_.originalEvent.dataTransfer.getData('path'),T=_.originalEvent.dataTransfer.items;if(P){var M=JSON.parse(P),S='cut';_.ctrlKey&&(S='copy'),'trash:///'===E&&(S='cut');var O={type:'file',data:{action:S,data:M,path:E}};_.altKey&&'trash:///'!==E?this.pastelink(O):this.paste(O)}else{if('trash:///'===E)return;this.upload(T,E)}return!1}},{key:'chmod',value:function chmod(_,C,z){API.files.chmod({data:{path:_,mode:C},success:z})}},{key:'readLocal',value:function readLocal(_,C,z){var E=function listEntries(T){T.file(function(M){M.href=C+T.fullPath.replace(/^\//,''),z&&z(M)})},P=function readFiles(T){for(var O,M=0,S=T.length;M<S;M++)O=T[M],O&&(O.isFile?E(O):O.createReader().readEntries(P))};P(_)}}]),g}(),upload=function g(_,C){_classCallCheck(this,g);var z='<li path="{0}" class="{1}"><div>{2}</div><label>{3}</label><a class="cancel">'+$.l10n.__('cancel')+'</a><a class="start">'+$.l10n.__('start')+'</a><a class="pause">'+$.l10n.__('pause')+'</a><progress></progress><span>{4}</span></li>',E=function add(M){C.$list.append(z.replace('{0}',M.href).replace('{1}',M.state).replace('{2}',M.name).replace('{3}',M.href).replace('{4}',M.status||'')),M.$li=$('[path="'+M.href+'"]:last',C.$list),M.$start=$('a.start',M.$li),M.$pause=$('a.pause',M.$li),M.$cancel=$('a.cancel',M.$li),M.$progress=$('progress',M.$li),M.$name=$('div',M.$li),M.$path=$('label',M.$li),M.$status=$('span',M.$li),M.$cancel.click(function(){'completed'!==M.state&&_.win.load(!0),M.$li.remove(),delete C.app.list[M.href],M=null}),M.$pause.click(function(){M.state='paused',M.$li.attr('class',M.state)}),M.$start.click(function(){M.state='queuing',M.$li.attr('class',M.state),M.$status.empty(),C.app.upload()})};if(!C.$list)for(var P in C.$list=$(document.createElement('ul')),C.$list.addClass('uploadList').appendTo(C.$content),C.$content.css({overflow:'auto'}),C.app.list)E(C.app.list[P]);if(C.app.list||(C.app.list={}),_.file&&!C.app.list[_.file.href]){var T=_.file;C.app.list[T.href]=T,T.state='queuing',E(T)}C.app.upload||(C.app.upload=function(){var M,S,O,I=new Date;for(var D in C.app.list){var N=C.app.list[D];M||'uploading'!==N.state||(M=N),S||'queuing'!==N.state||(S=N),O||'paused'!==N.state||(O=N)}if(!M){var Y=S||O;if(Y){Y.state='uploading';Y.loaded=0;var U=function read(){if(Y&&C.app.list[Y.href]&&'uploading'==Y.state){Y.ended=Y.loaded+51200,Y.ended>Y.size&&(Y.ended=Y.size);var V=Y.slice(Y.loaded,Y.ended);R(V)}},X=function success(V){if(Y&&C.app.list[Y.href]&&'uploading'==Y.state){var K=new Date;Y.path=OS.path.dirname(Y.href)+V.name,Y.$name.html(V.name),Y.$path.html(Y.path),Y.$li.attr('path',Y.path),Y.ended<Y.size?(Y.$status.html(parseInt(100*(Y.loaded/Y.size))+'% - '+bytesToSize(Y.loaded)+'/'+bytesToSize(Y.size)+'  '+timeToString(K-I)+' '+bytesToSize(1e3*(Y.loaded/(K-I)))+'/s'),Y.$progress.val(Y.loaded/Y.size),Y.loaded=Y.ended,U()):(_.win.load(!0),Y.$progress.val(1),Y.state='completed',Y.$li.attr('class',Y.state),Y.status=$.l10n.__('completed'),Y.$status.html('100% - '+bytesToSize(Y.size)+'/'+bytesToSize(Y.size)+'  '+timeToString(K-I)+' '+bytesToSize(1e3*(Y.size/(K-I)))+'/s'),delete C.app.list[Y.href],Y.$cancel.html($.l10n.__('remove')),Y.$start.remove(),Y.$pause.remove(),Y.$progress.remove(),Y=null,C.app.upload())}},G=function error(V){Y&&C.app.list[Y.href]&&(Y.state='error',Y.status=V,Y.$li.attr('class',Y.state),Y.$status.html(V),_.win.load(!0),C.app.upload())},R=function send(V){Y&&C.app.list[Y.href]&&OS.path.save({path:Y.href,headers:{Position:Y.loaded,Replace:'true'},data:V,success:X,error:G,nowaiting:!0})};U()}}}),C.app.upload()},path=function(){function g(){_classCallCheck(this,g),this.storage={},this.wins=[],this.ls({data:{path:'file:///'}}),this.ls({data:{path:'trash:///'}})}return _createClass(g,[{key:'dirname',value:function dirname(_){_=_.replace(/\/$/,'');var C=_.lastIndexOf('/'),z=_.substr(0,C+1);return /\:\/\/$/.test(z)&&(z='root:///'),z}},{key:'devname',value:function devname(_){if(0===_.indexOf('trash:///')||0===_.indexOf('share:///'))return null;if(0===_.indexOf('root:///')||'file:///'===_)return this.rootpath;if(0===_.indexOf('home:///')||0===_.indexOf('public:///')||0===_.indexOf('desktop:///')||0===_.indexOf('network:///'))return this.storagepath;if(0===_.indexOf('file:///')){var C=_.split('/');return C[3]?'file:///'+C[3]+'/':null}}},{key:'basename',value:function basename(_){_=_.replace(/\/$/,'');var C=_.lastIndexOf('/'),z=_.substr(C+1);return z}},{key:'rootname',value:function rootname(_){if(/\:\/\/\/$/.test(_))return _;var C=_.indexOf(':///'),z=_.substr(0,C+4);return z}},{key:'split',value:function split(_){_=_.replace(/\/$/,'');var C=_.indexOf('://'),z=_.substr(C+3),E=[_.substr(0,C+3)].concat(z.split(/\/+/));return E}},{key:'exists',value:function exists(_){return _.local?!!this.storage[p]:void API.files.exists({data:{path:_.path},success:_.success||function(){},error:_.error||function(){}})}},{key:'isfile',value:function isfile(_){return this.storage[_].prop[4]}},{key:'isdir',value:function isdir(_){return this.storage[_].prop[5]}},{key:'islink',value:function islink(_){return this.storage[_].prop[6]}},{key:'ismount',value:function ismount(_){return this.storage[_].prop[7]}},{key:'getProp',value:function getProp(_,C){var z=[],E=this.storage[_];if(!!E)C=E.prop;else if(!C)return null;var P={name:C[0],title:-1<$.inArray(_,['file:///','trash:///','public:///','desktop:///','network:///','home:///Desktop/','home:///Documents/','home:///Pictures/','home:///Music/','home:///Movies/','home:///Video/','home:///Downloads/','home:///Backup/'])?$.l10n.__(C[0].toLowerCase()):'home:///'===_?USERINFO.name:this.basename(C[0]),ext:C[1],mime:C[17].split('/')[0],type:C[5]?$.l10n.__('folder'):C[1].replace('.',''),size:C[2],sizestr:C[5]?C[2]:bytesToSize(C[2]),mtime:C[3],mtimestr:dateTimeToString(new Date(C[3]),'YYYY/MM/DD hh:mm'),isfile:C[4],isdir:C[5],islink:C[6],ismount:C[7],path:C[8],owner:C[9],group:C[10],mode:C[11],modestr:parseMode(C[11]),inode:C[12],usage:C[13],udev:C[14],classname:'',writable:!(-1<$.inArray(_,['file:///','trash:///','share:///']))&&C[15],thumbnail:C[16]?DOMAIN+this.dirname(_)+'.thumbnails/.'+this.basename(C[0])+'.jpg':null,rootpath:C[13]&&C[13].root?'file:///'+C[0]+'/':null,storagepath:C[13]&&C[13].storage?'file:///'+C[0]+'/storage/':null,MIME:C[17],charset:C[18]},T=P.udev;if(P.ismount&&'file:///'===this.dirname(_)&&(P.title=T.ID_FS_LABEL||('usb'===T.ID_BUS?$.l10n.__('usbdisk'):T.ID_CDROM?'CDROM':$.l10n.__('harddisk')),P.isdisk=!0),P.isfile){z.push('file'),z.push(C[17].split('/')[0]),z.push(C[17].split('/')[1]);var M=P.ext.replace('.','');z.push(M)}return P.isdir&&z.push(0===P.size?'dir0 dir':'dir'),P.islink&&z.push('link'),P.ismount&&'file:///'===this.dirname(_)&&z.push('mount '+('usb'===T.ID_BUS?'usb':'harddisk')+('1'===T.ID_CDROM?' cdrom':'')+('1'===T.ID_MTP_DEVICE?' android':'')+(P.usage.storage?' storage':'')+(P.usage.root?' root':'')),('file:///'===C[8]&&z.push('computer'),'trash:///'===C[8]&&(z.push('trash'),0<C[2]&&z.push('full')),-1<$.inArray(_,['home:///Documents/','home:///Pictures/','home:///Music/','home:///Movies/','home:///Video/','home:///Downloads/','home:///Desktop/','home:///Backup/'])&&z.push(C[0].toLowerCase()),z=z.join(' '),P.classname=z,P)}},{key:'getFolderProp',value:function getFolderProp(_){if(!OS.path.storage[_])return null;var C=OS.path.storage[_].children,z=[],E=!0,P=!1,T=void 0;try{for(var S,O,M=C[Symbol.iterator]();!(E=(S=M.next()).done);E=!0)O=S.value,z.push(OS.path.getProp(_+O[0]+(O[5]?'/':'')))}catch(I){P=!0,T=I}finally{try{!E&&M.return&&M.return()}finally{if(P)throw T}}return z}},{key:'chmod',value:function chmod(_){var C=this;API.files.chmod({data:_.data,success:function success(z){''===z.message&&(C.storage[_.data.path].prop[11]=_.data.mode),_.success&&_.success(z)}})}},{key:'ls',value:function ls(_){var C=this;API.files.ls({waiting:_.waiting,data:_.data,success:function success(z){var E=_.data.path;_.win&&(_.win.path=E),C.setStorage(E,z),C.refreshWin(E,!0),'trash:///'===E&&C.trash(),_.success&&_.success(z)},error:function error(z){_.win&&_.win.win.alert(z)}})}},{key:'trash',value:function trash(_){var C=this.storage['trash:///'],z=$('.trash',OS.desktop.$content);C&&C.children&&0<C.children.length||_?z.addClass('full'):z.removeClass('full')}},{key:'mkdir',value:function mkdir(_){var C=this;API.files.mkdir({data:_.data,success:function success(z){var E=C.dirname(_.data.path);C.delStorage(E),C.refreshWin(E),_.success&&_.success(z)}})}},{key:'mv',value:function mv(_){var C=this,z=[],E=_.data.path;'string'==typeof z&&(z=[_.data.path]);var P=!0,T=!1,M=void 0;try{for(var O,I,S=E[Symbol.iterator]();!(P=(O=S.next()).done);P=!0)I=O.value,-1===$.inArray(I,['trash:///','home:///','file:///','root:///','share:///'])&&z.push(I)}catch(Y){T=!0,M=Y}finally{try{!P&&S.return&&S.return()}finally{if(T)throw M}}if(0!=z.length){_.data.path=JSON.stringify(z);var D=_.data.newpath,N=OS.progress();API.files.mv({data:_.data,nowaiting:_.nowaiting,success:function success(Y){var L=[D],U=!0,X=!1,G=void 0;try{for(var V,R=z[Symbol.iterator]();!(U=(V=R.next()).done);U=!0){var K=V.value,Q=C.dirname(K);-1==$.inArray(Q,L)&&L.push(Q)}}catch(J){X=!0,G=J}finally{try{!U&&R.return&&R.return()}finally{if(X)throw G}}0===Q.indexOf('trash:///')&&(Q='trash:///',C.delStorage(Q)),C.delStorage(L),C.delStorage(D),C.refreshWin(Q),C.refreshWin(D),'trash:///'===D&&C.trash(!0),_.success&&_.success(Y),N.close()},error:function error(Y){_.error&&_.error(Y)}})}}},{key:'cp',value:function cp(_){var C=this,z=[],E=_.data.newpath,P=_.data.path;'string'==typeof P&&(P=[_.data.path]);var T=!0,M=!1,S=void 0;try{for(var I,D,O=P[Symbol.iterator]();!(T=(I=O.next()).done);T=!0)D=I.value,-1===$.inArray(D,['trash:///','file:///','root:///','share:///'])&&z.push(D)}catch(Y){M=!0,S=Y}finally{try{!T&&O.return&&O.return()}finally{if(M)throw S}}_.data.path=JSON.stringify(z);var N=OS.progress();API.files.cp({data:_.data,nowaiting:_.nowaiting,success:function success(Y){C.delStorage(E),C.refreshWin(E),_.success&&_.success(Y),N.close()},error:function error(Y){_.error&&_.error(Y)}})}},{key:'rm',value:function rm(_){var C=this,z=[],E=_.data.path;'string'==typeof E&&(E=[_.data.path]);var P=!0,T=!1,M=void 0;try{for(var O,I,S=E[Symbol.iterator]();!(P=(O=S.next()).done);P=!0)I=O.value,-1===$.inArray(I,['trash:///','home:///','file:///','root:///','share:///'])&&z.push(I)}catch(N){T=!0,M=N}finally{try{!P&&S.return&&S.return()}finally{if(T)throw M}}if(0!=z.length){_.data.path=JSON.stringify(z);var D=OS.progress();API.files.rm({data:_.data,nowaiting:_.nowaiting,success:function success(N){var Y=[],L=!0,U=!1,X=void 0;try{for(var R,G=z[Symbol.iterator]();!(L=(R=G.next()).done);L=!0){var V=R.value,K=C.dirname(V);-1===$.inArray(K,Y)&&Y.push(K)}}catch(Q){U=!0,X=Q}finally{try{!L&&G.return&&G.return()}finally{if(U)throw X}}C.delStorage(Y),C.refreshWin(Y),_.success&&_.success(N),D.close()}})}}},{key:'find',value:function find(_){var C=this,z=OS.progress();API.files.find({data:_.data,nowaiting:_.nowaiting,success:function success(E){var P=_.data.path;C.setStorage(P,E,!0),_.success&&_.success(E),z.close()}})}},{key:'zip',value:function zip(_){var C=this,z=OS.progress();API.files.zip({data:_.data,nowaiting:_.nowaiting,success:function success(E){C.refreshWin(_.data.path),_.success&&_.success(E),z.close()}})}},{key:'unzip',value:function unzip(_){var C=this,z=OS.progress();API.files.unzip({data:_.data,nowaiting:_.nowaiting,success:function success(E){C.refreshWin(_.data.path),_.success&&_.success(E),z.close()}})}},{key:'ln',value:function ln(_){var C=this,z=_.data.path;'string'==typeof z&&(z=[_.data.path]),_.data.path=JSON.stringify(z);var E=_.data.newpath;API.files.ln({data:_.data,success:function success(P){C.delStorage(E),C.refreshWin(E),_.success&&_.success(P)}})}},{key:'cleartrash',value:function cleartrash(_){var C=this;API.files.cleartrash({success:function success(z){C.delStorage('trash:///'),C.refreshWin('trash:///'),$('.fileicon.trash',OS.desktop.$content).removeClass('full'),_&&_.success&&_.success(z)}})}},{key:'open',value:function open(_){var C=this.getProp(_).mime;switch(C){case'text':case'code':OS.TextEditor.load(_);break;case'image':OS.ImageViewer.load(_);break;case'audio':case'video':OS.MediaPlayer.load(_);break;case'zip':break;default:OS.alert($.l10n.__('noapplication'));}}},{key:'read',value:function read(_){FETCH({url:_.path,method:'GET',dataType:'text',success:_.success})}},{key:'save',value:function save(_){FETCH({url:_.path,method:'PUT',headers:$.extend({"Content-Type":'application/application/octet-stream'},_.headers),data:_.data,success:_.success,waiting:_.waiting,nowaiting:_.nowaiting})}},{key:'localpath',value:function localpath(_){return 0===_.indexOf('/home/'+USERINFO.name+'/Desktop/')?_.replace('/home/'+USERINFO.name+'/Desktop/','desktop:///'):0===_.indexOf('/home/'+USERINFO.name+'/.network/')?_.replace('/home/'+USERINFO.name+'/.network/','network:///'):0===_.indexOf('/home/'+USERINFO.name+'/')?_.replace('/home/'+USERINFO.name+'/','home:///'):0===_.indexOf('/box/drives/')?_.replace('/box/drives/','file:///'):0===_.indexOf('/')?_.replace('/','file:///C:/'):void 0}},{key:'serverpath',value:function serverpath(_,C){if(0===_.indexOf('home:///'))return _.replace('home:///','/home/'+USERINFO.name+'/');if(0===_.indexOf('desktop:///'))return _.replace('desktop:///','/home/'+USERINFO.name+'/Desktop/');if(0===_.indexOf('public:///'))return _.replace('public:///','/home/Public/');if(0===_.indexOf('network:///'))return _.replace('network:///','/home/'+USERINFO.name+'/.network/');if(0===_.indexOf('file:///')){if(!C)return _.replace('file:///','/box/drives/');var z=_.replace('file:///',''),E=z.indexOf(':'),P=z.substr(0,E+2),T=z.substr(E+2),M=OS.path.storage['file:///'+P].prop[14].ID_FS_UUID;return'/media/'+M+'/'+T}}},{key:'getDrop',value:function getDrop(_){var C=_.originalEvent.dataTransfer.getData('path');if(C){var z=JSON.parse(C);return[0]===z.length&&(z=z[0]),z}var E=_.originalEvent.dataTransfer.items,P=[],T=!0,M=!1,S=void 0;try{for(var I,D,O=E[Symbol.iterator]();!(T=(I=O.next()).done);T=!0)D=I.value,P.push(D.webkitGetAsEntry())}catch(N){M=!0,S=N}finally{try{!T&&O.return&&O.return()}finally{if(M)throw S}}return P}},{key:'getStorage',value:function getStorage(_){return this.storage[_]}},{key:'setStorage',value:function setStorage(_,C,z){if(!z){for(var E in this.storage)0===E.indexOf(_)&&delete this.storage[E];this.storage[_]=C}var P=!0,T=!1,M=void 0;try{for(var O,S=(C.children||[])[Symbol.iterator]();!(P=(O=S.next()).done);P=!0){var I=O.value,D=('root:///'===_?'':_)+I[8];I[8]=D,this.storage[D]||(this.storage[D]={}),this.storage[D].prop=I}}catch(N){T=!0,M=N}finally{try{!P&&S.return&&S.return()}finally{if(T)throw M}}}},{key:'delStorage',value:function delStorage(_){for(var C in'string'==typeof _&&(_=[_]),this.storage){var z=!0,E=!1,P=void 0;try{for(var M,S,T=_[Symbol.iterator]();!(z=(M=T.next()).done);z=!0)S=M.value,0===C.indexOf(S)&&delete this.storage[C]}catch(O){E=!0,P=O}finally{try{!z&&T.return&&T.return()}finally{if(E)throw P}}}}},{key:'getUsage',value:function getUsage(_){var C=this.devname(_);if(C&&this.storage[C]){var z=this.getProp(C);return z.usage}return null}},{key:'addWin',value:function addWin(_){this.wins.push(_)}},{key:'delWin',value:function delWin(_){this.wins.splice($.inArray(_,this.wins),1)}},{key:'refreshWin',value:function refreshWin(_,C){C||this.delStorage(_),'string'==typeof _&&(_=[_]);var z=!0,E=!1,P=void 0;try{for(var M,T=this.wins[Symbol.iterator]();!(z=(M=T.next()).done);z=!0){var S=M.value,O=!0,I=!1,D=void 0;try{for(var Y,L,N=_[Symbol.iterator]();!(O=(Y=N.next()).done);O=!0)L=Y.value,0===S.path.indexOf(L)&&S.load()}catch(U){I=!0,D=U}finally{try{!O&&N.return&&N.return()}finally{if(I)throw D}}}}catch(U){E=!0,P=U}finally{try{!z&&T.return&&T.return()}finally{if(E)throw P}}}}]),g}();